<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LMS Admin - Full Provisioning & Management</title>
  <style>
    :root {
      --primary: #1e40af; --primary-dark: #1e3a8a;
      --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
      --gray: #6b7280; --light: #f3f4f6; --bg: #f8fafc;
    }
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin:0; color:#1f2937; height: 100vh; overflow: hidden; }
    
    .layout { display: grid; grid-template-columns: 240px 1fr; height:100vh; }
    aside { background:white; border-right:1px solid #e5e7eb; padding:1.5rem 0; overflow-y: auto; }
    .logo { padding:0 1.5rem 1.5rem; font-size:1.5rem; font-weight:bold; color:var(--primary-dark); border-bottom:1px solid #e5e7eb; }
    nav ul { list-style:none; padding:1rem 0; margin:0; }
    nav a { display:block; padding:0.75rem 1.5rem; color:#4b5563; text-decoration:none; font-weight:500; cursor: pointer; font-size: 14px; }
    nav a.active { background:var(--light); color:var(--primary); border-right: 4px solid var(--primary); }
    
    header { background:var(--primary); color:white; padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center; min-height: 65px; }
    main { padding:2rem; overflow-y:auto; height: calc(100vh - 65px); }
    
    .card { background:white; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.05); padding:1.5rem; margin-bottom:1.5rem; }
    .content-section { display: none; }
    .content-section.active { display: block; }
    
    table { width:100%; border-collapse:collapse; margin-top: 1rem; background: white; }
    th, td { padding:0.8rem; text-align:left; border-bottom:1px solid #e5e7eb; }
    th { background:var(--light); font-size: 0.85rem; color: var(--gray); }
    
    button { background:var(--primary); color:white; border:none; padding:0.6rem 1.2rem; border-radius:6px; cursor:pointer; font-weight:500; }
    button.danger { background: var(--danger); }
    button.success { background: var(--success); }
    
    input, select, textarea { padding:0.6rem; border:1px solid #d1d5db; border-radius:6px; width: 100%; margin-bottom: 10px; }
    .label { font-size: 12px; color: var(--gray); font-weight: 600; display: block; margin-bottom: 4px; }
    
    .subject-tag { display:inline-block; background:#dcfce7; color:#166534; padding:2px 8px; border-radius:4px; font-size:11px; margin:2px; border: 1px solid #bbf7d0; }
    
    #chat-box { height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; padding: 1rem; border-radius: 8px; background: #f9fafb; margin-bottom: 1rem; }
    .msg { margin-bottom: 0.8rem; padding: 0.5rem; border-radius: 5px; background: white; border: 1px solid #eee; }
    .msg b { color: var(--primary); font-size: 12px; display: block; }
  </style>
</head>
<body>

<div class="layout">
  <aside>
    <div class="logo">LMS Admin</div>
    <nav id="sidebar-nav" style="display:none;">
      <ul>
        <li><a class="nav-link active" data-target="invite-sec">Add Learner</a></li>
        <li><a class="nav-link" data-target="directory-sec">Directory</a></li>
        <li><a class="nav-link" data-target="materials-sec">Learning Materials</a></li>
        <li><a class="nav-link" data-target="assignments-sec">Assignments</a></li>
        <li><a class="nav-link" data-target="timetable-sec">Timetable</a></li>
        <li><a class="nav-link" data-target="chats-sec">Lecturer Chats</a></li>
        <li><a class="nav-link" data-target="reports-sec">Analytics</a></li>
      </ul>
    </nav>
  </aside>

  <div style="width:100%;">
    <header>
      <h2 id="view-title">Provisioning</h2>
      <button id="signOutBtn" style="background:rgba(255,255,255,0.2); display:none;">Sign Out</button>
    </header>

    <main>
      <div id="auth-section" class="card" style="max-width:400px; margin:5rem auto; text-align:center;">
        <h1>Admin Portal</h1>
        <button id="googleSignInBtn" style="width:100%; padding:1rem;">Sign in with Google</button>
      </div>

      <div id="dashboard" style="display:none;">
        
        <section id="invite-sec" class="content-section active">
          <div class="card">
            <h3>New Learner Provisioning</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
              <div>
                <label class="label">Learner Email</label>
                <input type="email" id="newLearnerEmail" placeholder="student@example.ac.za">
              </div>
              <div>
                <label class="label">Assign Qualification</label>
                <select class="qual-drop" id="qualSelect"></select>
              </div>
            </div>
            <div id="modulePreview" style="padding:15px; border:2px dashed #e5e7eb; border-radius:8px; margin: 10px 0;"></div>
            <button id="provisionBtn" class="success" style="width:100%;">Invite & Enroll Learner</button>
          </div>
        </section>

        <section id="directory-sec" class="content-section">
          <div class="card">
            <h3>Learner Directory</h3>
            <table>
              <thead><tr><th>Email</th><th>Qualification</th><th>Modules</th><th>Actions</th></tr></thead>
              <tbody id="directoryList"></tbody>
            </table>
          </div>
        </section>

        <section id="materials-sec" class="content-section">
          <div class="card">
            <h3>Upload Learning Materials</h3>
            <label class="label">Material Title</label>
            <input type="text" id="matTitle" placeholder="e.g. Lecture 1: Intro to Accounting">
            <label class="label">Target Qualification</label>
            <select class="qual-drop" id="matQual"></select>
            <label class="label">Resource URL (Drive/PDF Link)</label>
            <input type="text" id="matLink" placeholder="https://...">
            <button id="btnUploadMat" class="success">Post Material</button>
          </div>
        </section>

        <section id="assignments-sec" class="content-section">
          <div class="card">
            <h3>Issue Assignment</h3>
            <input type="text" id="assTitle" placeholder="Assignment Name">
            <select class="qual-drop" id="assQual"></select>
            <label class="label">Due Date</label>
            <input type="date" id="assDate">
            <button id="btnPostAss" class="success">Post Assignment</button>
          </div>
        </section>

        <section id="timetable-sec" class="content-section">
          <div class="card">
            <h3>Weekly Timetable Management</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
              <select id="ttDay"><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option></select>
              <input type="time" id="ttTime">
              <input type="text" id="ttSubject" placeholder="Subject Name">
            </div>
            <button id="btnAddTT" style="width:100%">Add Slot to Schedule</button>
            <table style="margin-top:20px;">
              <thead><tr><th>Day</th><th>Time</th><th>Subject</th></tr></thead>
              <tbody id="timetableList"></tbody>
            </table>
          </div>
        </section>

        <section id="chats-sec" class="content-section">
          <div class="card">
            <h3>Lecturer Announcement Chat</h3>
            <div id="chat-box"></div>
            <div style="display:flex; gap:10px;">
              <input type="text" id="chatInput" placeholder="Send a message to all students...">
              <button id="btnSendChat">Send</button>
            </div>
          </div>
        </section>

        <section id="reports-sec" class="content-section">
          <div style="display:flex; gap:20px; margin-bottom: 20px;">
            <div class="card" style="flex:1"><h3>Students</h3><h1 id="count-learners">0</h1></div>
            <div class="card" style="flex:1"><h3>Materials</h3><h1 id="count-mats">0</h1></div>
          </div>
          
          <div class="card">
            <h3>Student Assignment Submissions</h3>
            <table>
                <thead>
                    <tr>
                        <th>Student Email</th>
                        <th>Assignment</th>
                        <th>Link</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="submissionList"></tbody>
            </table>
          </div>
        </section>

      </div>
    </main>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getDatabase, ref, push, onValue, update, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDLvkRwSpd-hbPaDP31pV1H-4N5_Re-_xc",
    authDomain: "learnermanagementsystem-f3b6a.firebaseapp.com",
    databaseURL: "https://learnermanagementsystem-f3b6a-default-rtdb.firebaseio.com",
    projectId: "learnermanagementsystem-f3b6a",
    storageBucket: "learnermanagementsystem-f3b6a.firebasestorage.app",
    messagingSenderId: "173549259244",
    appId: "1:173549259244:web:f8722018a989c484a7d8c9"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const tertiaryCurriculum = {
    "BCom Accounting": ["Financial Accounting 101", "Business Management", "Commercial Law"],
    "BSc Computer Science": ["Intro to Programming", "Calculus 1", "Data Structures"],
    "LLB Law": ["Family Law", "Legal Foundations", "Criminal Law"],
    "Diploma in Engineering": ["Engineering Physics", "Technical Drawing", "Mechanics"]
  };

  // Auth Observer
  onAuthStateChanged(auth, (user) => {
    document.getElementById('auth-section').style.display = user ? 'none' : 'block';
    document.getElementById('dashboard').style.display = user ? 'block' : 'none';
    document.getElementById('sidebar-nav').style.display = user ? 'block' : 'none';
    document.getElementById('signOutBtn').style.display = user ? 'block' : 'none';
    if(user) initApp();
  });

  function initApp() {
    // Populate all qualification dropdowns
    document.querySelectorAll('.qual-drop').forEach(select => {
        select.innerHTML = '<option value="">-- Select Qual --</option>';
        Object.keys(tertiaryCurriculum).forEach(q => {
            select.innerHTML += `<option value="${q}">${q}</option>`;
        });
    });

    // Preview modules for learner provisioning
    document.getElementById('qualSelect').onchange = (e) => {
        const mods = tertiaryCurriculum[e.target.value] || [];
        document.getElementById('modulePreview').innerHTML = mods.map(m => `<span class="subject-tag">${m}</span>`).join('');
    };

    // Real-time Learners List
    onValue(ref(db, 'learners'), (snap) => {
      const list = document.getElementById('directoryList');
      list.innerHTML = '';
      let count = 0;
      snap.forEach(child => {
        count++;
        const d = child.val();
        list.innerHTML += `<tr><td>${d.email}</td><td>${d.assignedQual}</td><td>${(tertiaryCurriculum[d.assignedQual] || []).join(', ')}</td>
        <td><button class="danger" onclick="deleteItem('learners/${child.key}')">Delete</button></td></tr>`;
      });
      document.getElementById('count-learners').textContent = count;
    });

    // Real-time Materials Count
    onValue(ref(db, 'materials'), (snap) => {
      let count = 0;
      snap.forEach(() => count++);
      document.getElementById('count-mats').textContent = count;
    });

    // Real-time Timetable
    onValue(ref(db, 'timetable'), (snap) => {
      const list = document.getElementById('timetableList');
      list.innerHTML = '';
      snap.forEach(child => {
        const d = child.val();
        list.innerHTML += `<tr><td>${d.day}</td><td>${d.time}</td><td>${d.subject}</td></tr>`;
      });
    });

    // Real-time Chat
    onValue(ref(db, 'chats'), (snap) => {
      const box = document.getElementById('chat-box');
      box.innerHTML = '';
      snap.forEach(child => {
        const d = child.val();
        box.innerHTML += `<div class="msg"><b>${d.user}</b>${d.text}</div>`;
      });
      box.scrollTop = box.scrollHeight;
    });

    // Real-time Assignment Submissions (Added for Lecturer View)
    onValue(ref(db, 'submissions'), (snap) => {
      const list = document.getElementById('submissionList');
      list.innerHTML = '';
      snap.forEach(child => {
        const d = child.val();
        list.innerHTML += `<tr>
            <td>${d.studentEmail}</td>
            <td>${d.assignmentTitle}</td>
            <td><a href="${d.link}" target="_blank">View Work</a></td>
            <td><button class="danger" onclick="deleteItem('submissions/${child.key}')">Remove</button></td>
        </tr>`;
      });
    });
  }

  // --- Actions ---

  // Global Delete Helper
  window.deleteItem = (path) => { if(confirm("Delete this?")) remove(ref(db, path)); };

  document.getElementById('provisionBtn').onclick = async () => {
    const email = document.getElementById('newLearnerEmail').value;
    const qual = document.getElementById('qualSelect').value;
    if(email && qual) {
        await push(ref(db, 'learners'), { email, assignedQual: qual, createdAt: serverTimestamp() });
        alert("Learner Added");
    }
  };

  document.getElementById('btnUploadMat').onclick = async () => {
    const title = document.getElementById('matTitle').value;
    const qual = document.getElementById('matQual').value;
    const link = document.getElementById('matLink').value;
    if(title && qual && link) {
        await push(ref(db, 'materials'), { title, qual, link });
        alert("Material Uploaded");
    }
  };

  document.getElementById('btnPostAss').onclick = async () => {
    const title = document.getElementById('assTitle').value;
    const qual = document.getElementById('assQual').value;
    const dueDate = document.getElementById('assDate').value;
    if(title && qual && dueDate) {
        await push(ref(db, 'assignments'), { title, qual, dueDate });
        alert("Assignment Issued");
    }
  };

  document.getElementById('btnAddTT').onclick = async () => {
    const day = document.getElementById('ttDay').value;
    const time = document.getElementById('ttTime').value;
    const subject = document.getElementById('ttSubject').value;
    if(day && time && subject) {
        await push(ref(db, 'timetable'), { day, time, subject });
    }
  };

  document.getElementById('btnSendChat').onclick = async () => {
    const text = document.getElementById('chatInput').value;
    if(text && auth.currentUser) {
        const senderName = auth.currentUser.displayName || auth.currentUser.email;
        await push(ref(db, 'chats'), { user: senderName, text, ts: serverTimestamp() });
        document.getElementById('chatInput').value = '';
    }
  };

  // UI Navigation
  document.querySelectorAll('.nav-link').forEach(link => {
    link.onclick = () => {
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      link.classList.add('active');
      document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
      document.getElementById(link.dataset.target).classList.add('active');
      document.getElementById('view-title').textContent = link.textContent;
    };
  });

  document.getElementById('googleSignInBtn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
  document.getElementById('signOutBtn').onclick = () => signOut(auth);
</script>
</body>
</html>
