<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LMS Admin – Full Provisioning & Management</title>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    :root{
      --primary:#2563eb;--primary-hover:#1d4ed8;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;
      --gray:#64748b;--bg:#f8fafc;--card-bg:#ffffff;--text-main:#0f172a;--sidebar-w:260px;
      --border:#e2e8f0;--shadow:0 4px 6px -1px rgb(0 0 0 / 0.1),0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    body.dark-mode{
      --bg:#020617;--card-bg:#0f172a;--text-main:#f8fafc;--border:#1e293b;--gray:#94a3b8;
      --shadow:0 10px 15px -3px rgb(0 0 0 / 0.5);
    }
    *{box-sizing:border-box;transition:background-color .2s,color .2s,border-color .2s}
    body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);margin:0;color:var(--text-main);height:100vh;overflow:hidden}
    .layout{display:flex;height:100vh}
    aside{background:var(--card-bg);border-right:1px solid var(--border);padding:1.5rem 0;width:var(--sidebar-w);z-index:100;height:100vh;display:flex;flex-direction:column;box-shadow:var(--shadow);flex-shrink: 0;}
    .logo{padding:0 1.5rem 2rem;font-size:1.25rem;font-weight:800;color:var(--primary);display:flex;align-items:center;gap:12px}
    nav a{display:flex;align-items:center;padding:.8rem 1.2rem;color:var(--gray);text-decoration:none;font-weight:500;cursor:pointer;font-size:14px;white-space:nowrap;gap:12px;margin:4px 12px;border-radius:12px}
    nav a:hover{background:var(--bg);color:var(--primary)}
    nav a.active{background:#eff6ff;color:var(--primary);font-weight:600}
    body.dark-mode nav a.active{background:#1e3a8a;color:#60a5fa}
    .main-wrapper{flex:1; display:flex; flex-direction:column; min-width: 0;}
    header{background:var(--card-bg);padding:0 2.5rem;display:flex;justify-content:space-between;align-items:center;min-height:70px;border-bottom:1px solid var(--border)}
    main{padding:2.5rem;overflow-y:auto;flex:1}
    .card{background:var(--card-bg);border-radius:16px;border:1px solid var(--border);padding:1.8rem;margin-bottom:1.5rem;box-shadow:0 1px 3px 0 rgb(0 0 0 / .1)}
    .content-section{display:none;animation:fadeIn .3s ease}
    .content-section.active{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:1.2rem;text-align:left;border-bottom:1px solid var(--border)}
    th{background:var(--bg);font-size:.7rem;text-transform:uppercase;color:var(--gray);font-weight:700}
    button{background:var(--primary);color:#fff;border:none;padding:.65rem 1.4rem;border-radius:9999px;cursor:pointer;font-weight:600;font-size:14px;display:inline-flex;align-items:center;justify-content:center;gap:8px}
    button.secondary{background:var(--gray)}
    button.success{background:var(--success)}
    button.danger{background:var(--danger)}
    input,select,textarea{padding:.75rem;border:1px solid var(--border);border-radius:10px;width:100%;margin-bottom:12px;background:var(--bg);color:var(--text-main)}
    .label{font-size:12px;color:var(--gray);font-weight:600;display:block;margin-bottom:8px;text-transform:uppercase}
    .file-status{font-size: 12px; margin-bottom: 10px; display: block; color: var(--success); font-weight: 600;}
    #chat-box{height:300px;overflow-y:auto;border:1px solid var(--border);padding:1rem;border-radius:12px;background:var(--bg);margin-bottom:1rem}
    .msg{margin-bottom:1rem;padding:0.8rem;border-radius:12px;background:var(--card-bg);border:1px solid var(--border);max-width:85%}
    .subject-tag{display:inline-block;background:#f1f5f9;color:#475569;padding:4px 10px;border-radius:9999px;font-size:11px;margin:2px}
  </style>
</head>
<body>
<div class="layout">
  <aside id="sidebar">
    <div class="logo"><i data-lucide="layers"></i><span>LMS Admin</span></div>
    <nav id="sidebar-nav" style="display:none">
      <ul>
        <li><a class="nav-link active" data-target="invite-sec"><i data-lucide="user-plus"></i><span>Add Learner</span></a></li>
        <li><a class="nav-link" data-target="directory-sec"><i data-lucide="users"></i><span>Directory</span></a></li>
        <li><a class="nav-link" data-target="materials-sec"><i data-lucide="book-open"></i><span>Materials</span></a></li>
        <li><a class="nav-link" data-target="assignments-sec"><i data-lucide="file-text"></i><span>Assignments</span></a></li>
        <li><a class="nav-link" data-target="timetable-sec"><i data-lucide="calendar"></i><span>Timetable</span></a></li>
        <li><a class="nav-link" data-target="chats-sec"><i data-lucide="message-square"></i><span>Chats</span></a></li>
        <li><a class="nav-link" data-target="reports-sec"><i data-lucide="bar-chart-3"></i><span>Analytics</span></a></li>
      </ul>
    </nav>
  </aside>

  <div class="main-wrapper">
    <header>
      <h2 id="view-title">Provisioning</h2>
      <div style="display:flex;gap:15px;align-items:center">
        <div class="theme-toggle" id="themeToggle" style="cursor:pointer"><i data-lucide="moon" id="themeIcon"></i></div>
        <button id="signOutBtn" style="display:none;background:transparent;color:var(--text-main);border:1px solid var(--border)">Sign Out</button>
      </div>
    </header>

    <main>
      <div id="auth-section" class="card" style="max-width:400px;margin:5rem auto;text-align:center">
        <h1 style="font-size:1.5rem">Admin Portal</h1>
        <p style="color:var(--gray);margin-bottom:2rem">Secure access for faculty.</p>
        <button id="googleSignInBtn" style="width:100%"><i data-lucide="log-in"></i> Sign in with Google</button>
      </div>

      <div id="dashboard" style="display:none">
        <section id="invite-sec" class="content-section active">
          <div class="card">
            <h3>New Learner Provisioning</h3>
            <label class="label">Learner Email</label><input type="email" id="newLearnerEmail">
            <label class="label">Qualification</label><select class="qual-drop" id="qualSelect"></select>
            <div id="modulePreview" style="margin-bottom:1rem"></div>
            <button id="provisionBtn" class="success" style="width:100%">Invite & Enroll</button>
          </div>
        </section>

        <section id="directory-sec" class="content-section">
          <div class="card">
            <h3>Learner Directory</h3>
            <table><thead><tr><th>Email</th><th>Qual</th><th>Actions</th></tr></thead><tbody id="directoryList"></tbody></table>
          </div>
        </section>

        <section id="materials-sec" class="content-section">
          <div class="card">
            <h3>Upload Learning Materials</h3>
            <label class="label">Title</label><input type="text" id="matTitle" placeholder="e.g. Chapter 1 PDF">
            <label class="label">Qualification</label><select class="qual-drop" id="matQual"></select>
            <label class="label">PDF Document</label>
            <span id="matFileStatus" class="file-status"></span>
            <button id="btnUploadMatFile" class="secondary" style="width: 100%; margin-bottom: 1rem"><i data-lucide="upload-cloud"></i> 1. Select & Upload PDF</button>
            <input type="hidden" id="matLink">
            <button id="btnUploadMat" class="success" style="width: 100%">2. Post to Dashboard</button>
          </div>
          <div class="card">
            <h3>Live Materials List</h3>
            <table><thead><tr><th>Title</th><th>Qual</th><th>Link</th><th>Action</th></tr></thead><tbody id="materialsTableList"></tbody></table>
          </div>
        </section>

        <section id="assignments-sec" class="content-section">
          <div class="card">
            <h3>Issue Assignment</h3>
            <input type="text" id="assTitle" placeholder="Assignment Title">
            <select class="qual-drop" id="assQual"></select>
            <label class="label">Due Date</label><input type="date" id="assDate">
            <span id="assFileStatus" class="file-status"></span>
            <button id="btnUploadAssFile" class="secondary" style="width: 100%; margin-bottom: 1rem"><i data-lucide="file-up"></i> 1. Upload Assignment Brief</button>
            <input type="hidden" id="assLink">
            <button id="btnPostAss" class="success" style="width: 100%">2. Issue Assignment</button>
          </div>
        </section>

        <section id="timetable-sec" class="content-section">
          <div class="card">
            <h3>Schedule Slot</h3>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px">
                <select id="ttDay"><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option></select>
                <input type="time" id="ttTime"><input type="text" id="ttSubject" placeholder="Subject">
            </div>
            <button id="btnAddTT" style="width:100%;margin-top:1rem">Add Slot</button>
            <table><tbody id="timetableList"></tbody></table>
          </div>
        </section>

        <section id="chats-sec" class="content-section">
          <div class="card">
            <div id="chat-box"></div>
            <div style="display:flex;gap:10px"><input type="text" id="chatInput" placeholder="Broadcast message..."><button id="btnSendChat">Send</button></div>
          </div>
        </section>

        <section id="reports-sec" class="content-section">
            <div class="card">
                <h3>Student Submissions</h3>
                <table><thead><tr><th>Student</th><th>Task</th><th>Link</th></tr></thead><tbody id="submissionList"></tbody></table>
            </div>
        </section>
      </div>
    </main>
  </div>
</div>

<script type="module">
  import {initializeApp} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import {getAuth,signInWithPopup,GoogleAuthProvider,onAuthStateChanged,signOut} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import {getDatabase,ref,push,onValue,remove,serverTimestamp} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

  const firebaseConfig={
    apiKey:"AIzaSyDLvkRwSpd-hbPaDP31pV1H-4N5_Re-_xc",
    authDomain:"learnermanagementsystem-f3b6a.firebaseapp.com",
    databaseURL:"https://learnermanagementsystem-f3b6a-default-rtdb.firebaseio.com",
    projectId:"learnermanagementsystem-f3b6a",
    storageBucket:"learnermanagementsystem-f3b6a.firebasestorage.app",
    messagingSenderId:"173549259244",
    appId:"1:173549259244:web:f8722018a989c484a7d8c9"
  };

  const app=initializeApp(firebaseConfig);
  const auth=getAuth(app);
  const db=getDatabase(app);
  lucide.createIcons();

  // --- CLOUDINARY LOGIC ---
  const CLOUD_NAME = "dxp01qjvb";
  const UPLOAD_PRESET = "ml_default"; // Ensure this is "Unsigned" in Cloudinary settings

  const openUploadWidget = (targetInputId, statusId) => {
    window.cloudinary.openUploadWidget({
      cloudName: CLOUD_NAME,
      uploadPreset: UPLOAD_PRESET,
      sources: ['local', 'url'],
      clientAllowedFormats: ['pdf'],
      multiple: false
    }, (error, result) => {
      if (!error && result && result.event === "success") {
        document.getElementById(targetInputId).value = result.info.secure_url;
        document.getElementById(statusId).innerText = "✅ Uploaded: " + result.info.original_filename;
      }
    });
  };

  document.getElementById('btnUploadMatFile').onclick = () => openUploadWidget('matLink', 'matFileStatus');
  document.getElementById('btnUploadAssFile').onclick = () => openUploadWidget('assLink', 'assFileStatus');

  // --- APP LOGIC ---
  const curriculum = {
    "BCom Accounting":["FinAcc 1","Business Management"],
    "BSc Computer Science":["C++ Programming","Data Structures"],
    "LLB Law":["Criminal Law","Family Law"]
  };

  onAuthStateChanged(auth, user => {
    document.getElementById('auth-section').style.display=user?'none':'block';
    document.getElementById('dashboard').style.display=user?'block':'none';
    document.getElementById('sidebar-nav').style.display=user?'block':'none';
    document.getElementById('signOutBtn').style.display=user?'block':'none';
    if(user) initApp();
  });

  function initApp() {
    // Populate dropdowns
    document.querySelectorAll('.qual-drop').forEach(sel => {
      sel.innerHTML = '<option value="">Select Qual</option>';
      Object.keys(curriculum).forEach(q => sel.innerHTML += `<option value="${q}">${q}</option>`);
    });

    // Real-time Listeners
    onValue(ref(db, 'learners'), snap => {
      const list = document.getElementById('directoryList'); list.innerHTML = '';
      snap.forEach(c => {
        const d = c.val();
        list.innerHTML += `<tr><td>${d.email}</td><td>${d.assignedQual}</td><td><button class="danger" onclick="deleteItem('learners/${c.key}')">Remove</button></td></tr>`;
      });
    });

    onValue(ref(db, 'materials'), snap => {
      const list = document.getElementById('materialsTableList'); list.innerHTML = '';
      snap.forEach(c => {
        const d = c.val();
        list.innerHTML += `<tr><td>${d.title}</td><td>${d.qual}</td><td><a href="${d.link}" target="_blank">View</a></td><td><button class="danger" onclick="deleteItem('materials/${c.key}')">X</button></td></tr>`;
      });
    });

    onValue(ref(db, 'timetable'), snap => {
      const list = document.getElementById('timetableList'); list.innerHTML = '';
      snap.forEach(c => {
        const d = c.val();
        list.innerHTML += `<tr><td>${d.day}</td><td>${d.time}</td><td>${d.subject}</td></tr>`;
      });
    });

    onValue(ref(db,'chats'), snap => {
      const box = document.getElementById('chat-box'); box.innerHTML = '';
      snap.forEach(c => { box.innerHTML += `<div class="msg"><b>Admin</b><br>${c.val().text}</div>`; });
      box.scrollTop = box.scrollHeight;
    });

    onValue(ref(db,'submissions'), snap => {
        const list = document.getElementById('submissionList'); list.innerHTML = '';
        snap.forEach(c => {
            const d = c.val();
            list.innerHTML += `<tr><td>${d.studentEmail}</td><td>${d.assignmentTitle}</td><td><a href="${d.link}" target="_blank">Work</a></td></tr>`;
        });
    });
  }

  // Action Handlers
  window.deleteItem = path => { if(confirm("Delete?")) remove(ref(db, path)); };

  document.getElementById('provisionBtn').onclick = async () => {
    const email = document.getElementById('newLearnerEmail').value;
    const qual = document.getElementById('qualSelect').value;
    if(email && qual) { await push(ref(db, 'learners'), {email, assignedQual: qual}); alert("Enrolled!"); }
  };

  document.getElementById('btnUploadMat').onclick = async () => {
    const t = document.getElementById('matTitle').value, q = document.getElementById('matQual').value, l = document.getElementById('matLink').value;
    if(t && q && l) {
      await push(ref(db, 'materials'), {title:t, qual:q, link:l});
      alert("Posted!");
      document.getElementById('matTitle').value = ''; document.getElementById('matFileStatus').innerText = '';
    } else { alert("Upload PDF first!"); }
  };

  document.getElementById('btnPostAss').onclick = async () => {
    const t = document.getElementById('assTitle').value, q = document.getElementById('assQual').value, d = document.getElementById('assDate').value, l = document.getElementById('assLink').value;
    if(t && q && d && l) {
      await push(ref(db, 'assignments'), {title:t, qual:q, dueDate:d, link:l});
      alert("Issued!");
    }
  };

  document.getElementById('btnSendChat').onclick = async () => {
    const text = document.getElementById('chatInput').value;
    if(text) { await push(ref(db, 'chats'), {text, ts: serverTimestamp()}); document.getElementById('chatInput').value=''; }
  };

  // UI Interactivity
  document.querySelectorAll('.nav-link').forEach(link => {
    link.onclick = () => {
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      link.classList.add('active');
      document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
      document.getElementById(link.dataset.target).classList.add('active');
      document.getElementById('view-title').textContent = link.innerText.trim();
    };
  });

  document.getElementById('googleSignInBtn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
  document.getElementById('signOutBtn').onclick = () => signOut(auth);
</script>
</body>
</html>
