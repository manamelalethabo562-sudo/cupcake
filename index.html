<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LMS Admin – Full Provisioning & Management</title>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    :root{
      --primary:#2563eb;--primary-hover:#1d4ed8;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;
      --gray:#64748b;--bg:#f8fafc;--card-bg:#ffffff;--text-main:#0f172a;--sidebar-w:260px;
      --border:#e2e8f0;--shadow:0 4px 6px -1px rgb(0 0 0 / 0.1),0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    body.dark-mode{
      --bg:#020617;--card-bg:#0f172a;--text-main:#f8fafc;--border:#1e293b;--gray:#94a3b8;
      --shadow:0 10px 15px -3px rgb(0 0 0 / 0.5);
    }
    *{box-sizing:border-box;transition:background-color .2s,color .2s,border-color .2s}
    body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);margin:0;color:var(--text-main);height:100vh;overflow:hidden}
    .layout{display:flex;height:100vh}
    aside{background:var(--card-bg);border-right:1px solid var(--border);padding:1.5rem 0;width:var(--sidebar-w);z-index:100;height:100vh;display:flex;flex-direction:column;box-shadow:var(--shadow);flex-shrink: 0;}
    .logo{padding:0 1.5rem 2rem;font-size:1.25rem;font-weight:800;color:var(--primary);display:flex;align-items:center;gap:12px}
    nav a{display:flex;align-items:center;padding:.8rem 1.2rem;color:var(--gray);text-decoration:none;font-weight:500;cursor:pointer;font-size:14px;white-space:nowrap;gap:12px;margin:4px 12px;border-radius:12px}
    nav a.active{background:#eff6ff;color:var(--primary);font-weight:600}
    .main-wrapper{flex:1; display:flex; flex-direction:column; min-width: 0;}
    header{background:var(--card-bg);padding:0 2.5rem;display:flex;justify-content:space-between;align-items:center;min-height:70px;border-bottom:1px solid var(--border)}
    main{padding:2.5rem;overflow-y:auto;flex:1}
    .card{background:var(--card-bg);border-radius:16px;border:1px solid var(--border);padding:1.8rem;margin-bottom:1.5rem;box-shadow:0 1px 3px 0 rgb(0 0 0 / .1)}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:1.2rem;text-align:left;border-bottom:1px solid var(--border)}
    th{background:var(--bg);font-size:.7rem;text-transform:uppercase;color:var(--gray);font-weight:700}
    button{background:var(--primary);color:#fff;border:none;padding:.65rem 1.4rem;border-radius:9999px;cursor:pointer;font-weight:600;font-size:14px;display:inline-flex;align-items:center;justify-content:center;gap:8px}
    button.success{background:var(--success)}
    button.danger{background:var(--danger)}
    input,select,textarea{padding:.75rem;border:1px solid var(--border);border-radius:10px;width:100%;margin-bottom:12px;background:var(--bg);color:var(--text-main)}
    .label{font-size:12px;color:var(--gray);font-weight:600;display:block;margin-bottom:8px;text-transform:uppercase}
    .file-status{font-size: 12px; margin-bottom: 10px; display: block; color: var(--success); font-weight: 600;}
    .content-section{display:none}
    .content-section.active{display:block}
  </style>
</head>
<body>
<div class="layout">
  <aside id="sidebar">
    <div class="logo"><i data-lucide="layers"></i><span>LMS Admin</span></div>
    <nav id="sidebar-nav" style="display:none">
      <ul>
        <li><a class="nav-link active" data-target="invite-sec"><i data-lucide="user-plus"></i><span>Add Learner</span></a></li>
        <li><a class="nav-link" data-target="directory-sec"><i data-lucide="users"></i><span>Directory</span></a></li>
        <li><a class="nav-link" data-target="materials-sec"><i data-lucide="book-open"></i><span>Materials</span></a></li>
        <li><a class="nav-link" data-target="assignments-sec"><i data-lucide="file-text"></i><span>Assignments</span></a></li>
        <li><a class="nav-link" data-target="timetable-sec"><i data-lucide="calendar"></i><span>Timetable</span></a></li>
        <li><a class="nav-link" data-target="chats-sec"><i data-lucide="message-square"></i><span>Chats</span></a></li>
        <li><a class="nav-link" data-target="reports-sec"><i data-lucide="bar-chart-3"></i><span>Analytics</span></a></li>
      </ul>
    </nav>
  </aside>

  <div class="main-wrapper">
    <header>
      <h2 id="view-title">Provisioning</h2>
      <div style="display:flex;gap:15px;align-items:center">
        <button id="signOutBtn" style="display:none;background:transparent;color:var(--text-main);border:1px solid var(--border)">Sign Out</button>
      </div>
    </header>

    <main>
      <div id="auth-section" class="card" style="max-width:400px;margin:5rem auto;text-align:center">
        <h1>Admin Portal</h1>
        <button id="googleSignInBtn" style="width:100%"><i data-lucide="log-in"></i> Sign in with Google</button>
      </div>

      <div id="dashboard" style="display:none">
        <section id="invite-sec" class="content-section active">
          <div class="card">
            <h3>New Learner Provisioning</h3>
            <label class="label">Learner Email</label>
            <input type="email" id="newLearnerEmail" placeholder="student@example.com">
            
            <label class="label">Qualification</label>
            <select class="qual-drop" id="qualSelect"></select>
            
            <label class="label">Included Subjects (Comma separated)</label>
            <textarea id="learnerSubjects" placeholder="Enter subjects for this student..." rows="3" style="width:100%"></textarea>
            
            <button id="provisionBtn" class="success" style="width:100%; margin-top:1rem">Invite & Enroll Learner</button>
          </div>
        </section>

        <section id="directory-sec" class="content-section">
          <div class="card">
            <h3>Learner Directory</h3>
            <table>
                <thead><tr><th>Email</th><th>Qualification</th><th>Subjects</th><th>Actions</th></tr></thead>
                <tbody id="directoryList"></tbody>
            </table>
          </div>
        </section>

        <section id="materials-sec" class="content-section">
          <div class="card">
            <h3>Upload Learning Materials</h3>
            <input type="text" id="matTitle" placeholder="Material Title">
            <select class="qual-drop" id="matQual"></select>
            <span id="matFileStatus" class="file-status"></span>
            <button id="btnUploadMatFile" style="width:100%;margin-bottom:1rem">1. Upload PDF</button>
            <input type="hidden" id="matLink">
            <button id="btnUploadMat" class="success" style="width:100%">2. Post Material</button>
          </div>
        </section>

        <section id="assignments-sec" class="content-section"><div class="card"><h3>Assignments</h3><p>Manage assignments here.</p></div></section>
        <section id="timetable-sec" class="content-section"><div class="card"><h3>Timetable</h3><p>Manage schedule here.</p></div></section>
        <section id="chats-sec" class="content-section"><div class="card"><h3>Chat</h3><div id="chat-box"></div></div></section>
        <section id="reports-sec" class="content-section"><div class="card"><h3>Analytics</h3><p>View reports here.</p></div></section>
      </div>
    </main>
  </div>
</div>

<script type="module">
  import {initializeApp} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import {getAuth,signInWithPopup,GoogleAuthProvider,onAuthStateChanged,signOut} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import {getDatabase,ref,push,onValue,remove,serverTimestamp} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

  const firebaseConfig={
    apiKey:"AIzaSyDLvkRwSpd-hbPaDP31pV1H-4N5_Re-_xc",
    authDomain:"learnermanagementsystem-f3b6a.firebaseapp.com",
    databaseURL:"https://learnermanagementsystem-f3b6a-default-rtdb.firebaseio.com",
    projectId:"learnermanagementsystem-f3b6a",
    storageBucket:"learnermanagementsystem-f3b6a.firebasestorage.app",
    messagingSenderId:"173549259244",
    appId:"1:173549259244:web:f8722018a989c484a7d8c9"
  };

  const app=initializeApp(firebaseConfig);
  const auth=getAuth(app);
  const db=getDatabase(app);
  lucide.createIcons();

  const curriculum = {
    "BCom Accounting":["Financial Accounting","Commercial Law","Taxation"],
    "BSc Computer Science":["Algorithms","Web Dev","Database Systems"],
    "LLB Law":["Legal Research","Civil Procedure","Constitutional Law"]
  };

  onAuthStateChanged(auth, user => {
    document.getElementById('auth-section').style.display=user?'none':'block';
    document.getElementById('dashboard').style.display=user?'block':'none';
    document.getElementById('sidebar-nav').style.display=user?'block':'none';
    document.getElementById('signOutBtn').style.display=user?'block':'none';
    if(user) initApp();
  });

  function initApp() {
    // Populate Dropdowns
    document.querySelectorAll('.qual-drop').forEach(sel => {
      sel.innerHTML = '<option value="">-- Select Qual --</option>';
      Object.keys(curriculum).forEach(q => sel.innerHTML += `<option value="${q}">${q}</option>`);
    });

    // Auto-fill subjects when qualification is selected
    document.getElementById('qualSelect').onchange = (e) => {
      const selectedQual = e.target.value;
      const subjects = curriculum[selectedQual] || [];
      document.getElementById('learnerSubjects').value = subjects.join(", ");
    };

    // Directory Listener
    onValue(ref(db, 'learners'), snap => {
      const list = document.getElementById('directoryList'); list.innerHTML = '';
      snap.forEach(c => {
        const d = c.val();
        list.innerHTML += `<tr>
            <td>${d.email}</td>
            <td><b>${d.assignedQual}</b></td>
            <td style="font-size:12px; color:var(--gray)">${d.subjects || 'None'}</td>
            <td><button class="danger" onclick="deleteItem('learners/${c.key}')">Remove</button></td>
        </tr>`;
      });
    });

    // Cloudinary Upload (Functionality Fix)
    document.getElementById('btnUploadMatFile').onclick = () => {
        window.cloudinary.openUploadWidget({
            cloudName: "dxp01qjvb", 
            uploadPreset: "ml_default"
        }, (error, result) => {
            if (!error && result.event === "success") {
                document.getElementById('matLink').value = result.info.secure_url;
                document.getElementById('matFileStatus').innerText = "✅ PDF Ready: " + result.info.original_filename;
            }
        });
    };
  }

  // Provision Learner with custom subjects
  document.getElementById('provisionBtn').onclick = async () => {
    const email = document.getElementById('newLearnerEmail').value;
    const qual = document.getElementById('qualSelect').value;
    const subjects = document.getElementById('learnerSubjects').value;
    
    if(email && qual && subjects) {
        await push(ref(db, 'learners'), {
            email, 
            assignedQual: qual, 
            subjects: subjects,
            createdAt: serverTimestamp()
        });
        alert("Learner Provisioned Successfully!");
        document.getElementById('newLearnerEmail').value = '';
        document.getElementById('learnerSubjects').value = '';
    } else {
        alert("Please fill in all fields.");
    }
  };

  window.deleteItem = path => { if(confirm("Delete?")) remove(ref(db, path)); };

  // Nav Logic
  document.querySelectorAll('.nav-link').forEach(link => {
    link.onclick = () => {
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      link.classList.add('active');
      document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
      document.getElementById(link.dataset.target).classList.add('active');
      document.getElementById('view-title').textContent = link.innerText.trim();
    };
  });

  document.getElementById('googleSignInBtn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
  document.getElementById('signOutBtn').onclick = () => signOut(auth);
</script>
</body>
</html>
