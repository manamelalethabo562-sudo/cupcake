<body>
<div class="layout">
  <aside>
    <div class="logo">LMS Admin</div>
    <nav>
      <ul>
        <li><a href="#" class="active">Learners</a></li>
        <li><a href="#courses-section">Courses</a></li>
        <li><a href="#">Assignments</a></li>
        <li><a href="#">Reports</a></li>
      </ul>
    </nav>
  </aside>

  <div style="display:flex; flex-direction:column; height:100vh;">
    <header>
      <h1 style="margin:0; font-size:1.4rem;">Manage Learners & Courses</h1>
      <button id="signOutBtn">Sign Out</button>
    </header>

    <main>
      <div id="auth-section" class="card" style="max-width:500px; margin:4rem auto; display:none;">
        <h2>Admin Login</h2>
        <button id="googleSignInBtn">Sign in with Google</button>
        <div id="authMessage"></div>
      </div>

      <div id="dashboard" style="display:none;">

        <!-- Invite Learner -->
        <div class="card">
          <h2>Invite New Learner</h2>
          <form id="inviteForm" style="display:flex; gap:1rem; flex-wrap:wrap;">
            <input type="email" id="learnerEmail" placeholder="Learner's email" required style="flex:1;" />
            <button type="submit">Send Invite</button>
          </form>
          <div id="message"></div>
        </div>

        <!-- Courses Section -->
        <div class="card" id="courses-section">
          <h2>Courses</h2>
          <form id="addCourseForm" style="margin-bottom:2rem;">
            <input type="text" id="courseTitle" placeholder="Course title" required style="width:100%; margin-bottom:0.75rem;" />
            <textarea id="courseDesc" placeholder="Short description" rows="2" style="width:100%; margin-bottom:0.75rem;"></textarea>
            <button type="submit">Create Course</button>
          </form>
          <div class="courses-grid" id="coursesList"></div>
        </div>

        <!-- Learners Table -->
        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:1rem; margin-bottom:1.25rem;">
            <h2>Learners & Course Assignments</h2>
            <div>
              <select id="courseSelectForAssign" style="margin-right:0.75rem; min-width:220px;">
                <option value="">Select course to assign (bulk)...</option>
              </select>
              <button id="bulkAssignBtn" class="secondary" disabled>Bulk Assign Selected</button>
            </div>
          </div>

          <table id="learnersTable">
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAll" /></th>
                <th>Email</th>
                <th>Name</th>
                <th>Status</th>
                <th>Assigned Courses</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- ─── Custom Assignment Modal ────────────────────────────────────── -->
  <div id="assignModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close-modal" onclick="closeAssignModal()">&times;</span>
      <h2>Assign Courses</h2>
      <p id="modalLearnerInfo">Assigning to: <strong id="modalEmail"></strong></p>

      <div style="margin:1.5rem 0; max-height:320px; overflow-y:auto; border:1px solid #e5e7eb; border-radius:6px; padding:1rem;">
        <div id="coursesInModal"></div>
      </div>

      <div style="text-align:right;">
        <button class="secondary" onclick="closeAssignModal()">Cancel</button>
        <button id="saveAssignmentsBtn">Assign Selected</button>
      </div>
    </div>
  </div>
</div>

<style>
  .modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  .modal-content {
    background: white;
    border-radius: 10px;
    width: 90%;
    max-width: 560px;
    padding: 2rem;
    position: relative;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  }
  .close-modal {
    position: absolute;
    top: 12px;
    right: 20px;
    font-size: 2rem;
    cursor: pointer;
    color: #6b7280;
  }
  .close-modal:hover { color: #374151; }
  .course-checkbox {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 0;
    border-bottom: 1px solid #f3f4f6;
  }
  .course-checkbox:last-child { border-bottom: none; }
  .course-checkbox label {
    flex: 1;
    cursor: pointer;
    font-weight: 500;
  }
  .already-assigned {
    color: var(--success);
    font-size: 0.85rem;
    margin-left: 0.5rem;
  }
</style>

<script type="module">
  // ──────────────────────────────────────────────────────────────
  // Your existing firebaseConfig + imports (unchanged)
  // ──────────────────────────────────────────────────────────────
  const firebaseConfig = { /* ... your config ... */ };
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getDatabase, ref, push, set, serverTimestamp, onValue, query, orderByChild, remove, update, get } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  let currentUser = null;
  let coursesMap = {};
  let selectedLearnerKey = null;
  let selectedLearnerEmail = null;

  // ─── Modal Controls ─────────────────────────────────────────────
  function openAssignModal(learnerKey, email) {
    selectedLearnerKey = learnerKey;
    selectedLearnerEmail = email;
    document.getElementById('modalEmail').textContent = email;
    document.getElementById('assignModal').style.display = 'flex';
    loadCoursesIntoModal(learnerKey);
  }

  function closeAssignModal() {
    document.getElementById('assignModal').style.display = 'none';
    selectedLearnerKey = null;
    selectedLearnerEmail = null;
  }

  window.openAssignModal = openAssignModal;
  window.closeAssignModal = closeAssignModal;

  // ─── Load courses into modal + check existing assignments ──────
  async function loadCoursesIntoModal(learnerKey) {
    const container = document.getElementById('coursesInModal');
    container.innerHTML = '<p>Loading courses...</p>';

    // Get current assignments for this learner
    const assignmentsRef = ref(db, 'courseAssignments');
    const snapshot = await get(query(assignmentsRef));
    const currentAssignments = new Set();

    if (snapshot.exists()) {
      snapshot.forEach(child => {
        const ass = child.val();
        if (ass.learnerId === learnerKey && ass.status !== 'archived') {
          currentAssignments.add(ass.courseId);
        }
      });
    }

    // Now render courses
    const coursesRef = ref(db, 'courses');
    onValue(coursesRef, (snap) => {
      container.innerHTML = '';
      if (!snap.exists()) {
        container.innerHTML = '<p style="text-align:center;color:var(--gray);">No courses available yet</p>';
        return;
      }

      coursesMap = {};
      const courses = [];
      snap.forEach(child => {
        const c = child.val();
        c.key = child.key;
        coursesMap[c.key] = c;
        courses.push(c);
      });

      courses.sort((a,b) => a.title.localeCompare(b.title));

      courses.forEach(course => {
        const isAssigned = currentAssignments.has(course.key);
        const div = document.createElement('div');
        div.className = 'course-checkbox';
        div.innerHTML = `
          <input type="checkbox" id="course-${course.key}" value="${course.key}" ${isAssigned ? 'checked' : ''} />
          <label for="course-${course.key}">${course.title}</label>
          ${isAssigned ? '<span class="already-assigned">(already assigned)</span>' : ''}
        `;
        container.appendChild(div);
      });
    }, { onlyOnce: true });
  }

  // ─── Save assignments from modal ────────────────────────────────
  document.getElementById('saveAssignmentsBtn')?.addEventListener('click', async () => {
    if (!selectedLearnerKey) return;

    const checkedBoxes = document.querySelectorAll('#coursesInModal input[type="checkbox"]:checked');
    const selectedCourseIds = Array.from(checkedBoxes).map(cb => cb.value);

    if (selectedCourseIds.length === 0) {
      alert("No courses selected.");
      return;
    }

    if (!confirm(`Assign ${selectedCourseIds.length} course(s) to ${selectedLearnerEmail}?`)) return;

    const messageDiv = document.getElementById('message');
    const updates = {};
    const now = serverTimestamp();

    // For simplicity: remove old assignments and add new ones (you can improve this later)
    // Better in production: compare and only add/remove differences

    // Optional: clear existing (if you want replace behavior)
    // await remove(ref(db, `courseAssignments`)) — scoped better with query

    let addedCount = 0;
    for (const courseId of selectedCourseIds) {
      const assignRef = push(ref(db, 'courseAssignments'));
      updates[`courseAssignments/${assignRef.key}`] = {
        courseId,
        learnerId: selectedLearnerKey,
        assignedAt: now,
        assignedBy: currentUser?.uid || 'admin',
        status: 'assigned'
      };
      addedCount++;
    }

    // Update count on learner (approximate)
    updates[`learners/${selectedLearnerKey}/assignedCourseCount`] = selectedCourseIds.length;

    try {
      await update(ref(db), updates);
      messageDiv.textContent = `Assigned ${addedCount} course(s) to ${selectedLearnerEmail}`;
      messageDiv.className = 'success';
      closeAssignModal();
    } catch (err) {
      messageDiv.textContent = `Error: ${err.message}`;
      messageDiv.className = 'error';
    }
  });

  // ─── Learners table – updated Assign button ─────────────────────
  function loadLearnersList() {
    const learnersRef = ref(db, 'learners');
    onValue(query(learnersRef, orderByChild('invitedAt')), (snap) => {
      const tbody = document.querySelector('#learnersTable tbody');
      tbody.innerHTML = '';

      if (!snap.exists()) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:3rem;">No learners yet</td></tr>';
        return;
      }

      const learners = [];
      snap.forEach(child => {
        const d = child.val();
        d.key = child.key;
        learners.push(d);
      });

      learners.sort((a,b) => (b.invitedAt||0) - (a.invitedAt||0));

      learners.forEach(data => {
        const row = document.createElement('tr');
        const statusClass = `status-${(data.status||'pending').toLowerCase()}`;
        const courseCount = data.assignedCourseCount || 0;

        row.innerHTML = `
          <td><input type="checkbox" class="row-select" data-key="${data.key}" /></td>
          <td>${data.email}</td>
          <td>${data.name || '—'}</td>
          <td><span class="status-badge ${statusClass}">${data.status || 'Pending'}</span></td>
          <td>${courseCount} course${courseCount !== 1 ? 's' : ''}</td>
          <td>
            <button onclick="openAssignModal('${data.key}', '${data.email.replace(/'/g, "\\'")}')">Assign Courses</button>
            <button class="secondary" onclick="viewAssignments('${data.key}')">View</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    });
  }

  // Rest of your script (loadCourses, addCourseForm, inviteForm, bulk assign, etc.) remains the same
  // ... paste the rest of your existing script here ...

  // Make sure to keep your existing event listeners and functions
</script>
</body>
</html>
