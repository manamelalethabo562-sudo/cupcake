<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LMS Admin - Full Provisioning & Management</title>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    :root {
      --primary: #2563eb; 
      --primary-hover: #1d4ed8;
      --success: #10b981; 
      --warning: #f59e0b; 
      --danger: #ef4444;
      --gray: #64748b; 
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text-main: #1e293b;
      --sidebar-w: 70px;
      --sidebar-w-expanded: 240px;
      --border: #e2e8f0;
    }

    /* Dark Mode Variables */
    body.dark-mode {
      --bg: #0f172a;
      --card-bg: #1e293b;
      --text-main: #f1f5f9;
      --border: #334155;
      --gray: #94a3b8;
    }

    * { box-sizing: border-box; transition: background-color 0.3s, color 0.3s, width 0.3s; }
    
    body { 
      font-family: 'Inter', system-ui, -apple-system, sans-serif; 
      background: var(--bg); 
      margin:0; 
      color: var(--text-main); 
      height: 100vh; 
      overflow: hidden; 
    }
    
    .layout { display: grid; grid-template-columns: var(--sidebar-w) 1fr; height:100vh; }
    .layout.expanded { grid-template-columns: var(--sidebar-w-expanded) 1fr; }

    /* Collapsible Sidebar */
    aside { 
      background: var(--card-bg); 
      border-right: 1px solid var(--border); 
      padding: 1rem 0; 
      overflow: hidden; 
      width: var(--sidebar-w);
      z-index: 100;
      position: absolute;
      height: 100vh;
      transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    aside:hover { width: var(--sidebar-w-expanded); box-shadow: 10px 0 15px -3px rgba(0,0,0,0.1); }
    
    .logo { 
      padding: 0 1.2rem 1.5rem; 
      font-size: 1.25rem; 
      font-weight: 800; 
      color: var(--primary); 
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    nav ul { list-style:none; padding:0; margin:0; }
    nav a { 
      display: flex; 
      align-items: center;
      padding: 0.8rem 1.4rem; 
      color: var(--gray); 
      text-decoration: none; 
      font-weight: 500; 
      cursor: pointer; 
      font-size: 14px; 
      white-space: nowrap;
      gap: 20px;
    }
    nav a i { min-width: 24px; }
    nav a:hover { background: var(--bg); color: var(--primary); }
    nav a.active { background: #dbeafe; color: var(--primary); border-right: 4px solid var(--primary); }
    body.dark-mode nav a.active { background: #1e3a8a; color: #60a5fa; }
    
    .main-wrapper { margin-left: var(--sidebar-w); width: calc(100% - var(--sidebar-w)); }

    header { 
      background: var(--card-bg); 
      color: var(--text-main); 
      padding: 0 2rem; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      min-height: 65px; 
      border-bottom: 1px solid var(--border);
    }
    
    main { padding: 2rem; overflow-y: auto; height: calc(100vh - 65px); }
    
    .card { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border); padding: 1.5rem; margin-bottom: 1.5rem; }
    .content-section { display: none; }
    .content-section.active { display: block; }
    
    table { width:100%; border-collapse:collapse; margin-top: 1rem; }
    th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border); }
    th { background: var(--bg); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray); }
    
    /* Pill Buttons */
    button { 
      background: var(--primary); 
      color: white; 
      border: none; 
      padding: 0.7rem 1.5rem; 
      border-radius: 9999px; 
      cursor: pointer; 
      font-weight: 600; 
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    button:hover { opacity: 0.9; transform: translateY(-1px); }
    button.danger { background: var(--danger); }
    button.success { background: var(--success); }
    
    input, select, textarea { 
      padding: 0.7rem; 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      width: 100%; 
      margin-bottom: 10px; 
      background: var(--bg);
      color: var(--text-main);
    }

    .label { font-size: 12px; color: var(--gray); font-weight: 600; display: block; margin-bottom: 6px; }
    .subject-tag { display:inline-block; background:#dcfce7; color:#166534; padding:4px 12px; border-radius:9999px; font-size:11px; margin:2px; border: 1px solid #bbf7d0; }
    
    /* Dark Mode Toggle */
    .theme-toggle {
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #chat-box { height: 300px; overflow-y: auto; border: 1px solid var(--border); padding: 1rem; border-radius: 12px; background: var(--bg); margin-bottom: 1rem; }
    .msg { margin-bottom: 0.8rem; padding: 0.8rem; border-radius: 12px; background: var(--card-bg); border: 1px solid var(--border); }
    .msg b { color: var(--primary); font-size: 12px; display: block; margin-bottom: 4px; }
  </style>
</head>
<body>

<div class="layout">
  <aside id="sidebar">
    <div class="logo">
      <i data-lucide="layers"></i>
      <span>LMS Admin</span>
    </div>
    <nav id="sidebar-nav" style="display:none;">
      <ul>
        <li><a class="nav-link active" data-target="invite-sec"><i data-lucide="user-plus"></i><span>Add Learner</span></a></li>
        <li><a class="nav-link" data-target="directory-sec"><i data-lucide="users"></i><span>Directory</span></a></li>
        <li><a class="nav-link" data-target="materials-sec"><i data-lucide="book-open"></i><span>Materials</span></a></li>
        <li><a class="nav-link" data-target="assignments-sec"><i data-lucide="file-text"></i><span>Assignments</span></a></li>
        <li><a class="nav-link" data-target="timetable-sec"><i data-lucide="calendar"></i><span>Timetable</span></a></li>
        <li><a class="nav-link" data-target="chats-sec"><i data-lucide="message-square"></i><span>Chats</span></a></li>
        <li><a class="nav-link" data-target="reports-sec"><i data-lucide="bar-chart-3"></i><span>Analytics</span></a></li>
      </ul>
    </nav>
  </aside>

  <div class="main-wrapper">
    <header>
      <h2 id="view-title">Provisioning</h2>
      <div style="display:flex; gap:15px; align-items:center;">
        <div class="theme-toggle" id="themeToggle">
            <i data-lucide="moon" id="themeIcon"></i>
        </div>
        <button id="signOutBtn" style="display:none; background: var(--bg); color: var(--text-main); border: 1px solid var(--border);">Sign Out</button>
      </div>
    </header>

    <main>
      <div id="auth-section" class="card" style="max-width:400px; margin:5rem auto; text-align:center;">
        <i data-lucide="shield-check" style="width:48px; height:48px; color:var(--primary); margin-bottom:1rem;"></i>
        <h1>Admin Portal</h1>
        <p style="color:var(--gray); margin-bottom:2rem;">Please sign in to manage your institution.</p>
        <button id="googleSignInBtn" style="width:100%; padding:1rem;">Sign in with Google</button>
      </div>

      <div id="dashboard" style="display:none;">
        
        <section id="invite-sec" class="content-section active">
          <div class="card">
            <h3>New Learner Provisioning</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
              <div>
                <label class="label">Learner Email</label>
                <input type="email" id="newLearnerEmail" placeholder="student@example.ac.za">
              </div>
              <div>
                <label class="label">Assign Qualification</label>
                <select class="qual-drop" id="qualSelect"></select>
              </div>
            </div>
            <div id="modulePreview" style="padding:15px; border:2px dashed var(--border); border-radius:8px; margin: 10px 0;"></div>
            <button id="provisionBtn" class="success" style="width:100%;">Invite & Enroll Learner</button>
          </div>
        </section>

        <section id="directory-sec" class="content-section">
          <div class="card">
            <h3>Learner Directory</h3>
            <table>
              <thead><tr><th>Email</th><th>Qualification</th><th>Modules</th><th>Actions</th></tr></thead>
              <tbody id="directoryList"></tbody>
            </table>
          </div>
        </section>

        <section id="materials-sec" class="content-section">
          <div class="card">
            <h3>Upload Learning Materials</h3>
            <label class="label">Material Title</label>
            <input type="text" id="matTitle" placeholder="e.g. Lecture 1: Intro to Accounting">
            <label class="label">Target Qualification</label>
            <select class="qual-drop" id="matQual"></select>
            <label class="label">Resource URL (Drive/PDF Link)</label>
            <input type="text" id="matLink" placeholder="https://...">
            <button id="btnUploadMat" class="success">Post Material</button>
          </div>
        </section>

        <section id="assignments-sec" class="content-section">
          <div class="card">
            <h3>Issue Assignment</h3>
            <input type="text" id="assTitle" placeholder="Assignment Name">
            <select class="qual-drop" id="assQual"></select>
            <label class="label">Due Date</label>
            <input type="date" id="assDate">
            <button id="btnPostAss" class="success">Post Assignment</button>
          </div>
        </section>

        <section id="timetable-sec" class="content-section">
          <div class="card">
            <h3>Weekly Timetable Management</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
              <select id="ttDay"><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option></select>
              <input type="time" id="ttTime">
              <input type="text" id="ttSubject" placeholder="Subject Name">
            </div>
            <button id="btnAddTT" style="width:100%">Add Slot to Schedule</button>
            <table style="margin-top:20px;">
              <thead><tr><th>Day</th><th>Time</th><th>Subject</th></tr></thead>
              <tbody id="timetableList"></tbody>
            </table>
          </div>
        </section>

        <section id="chats-sec" class="content-section">
          <div class="card">
            <h3>Lecturer Announcement Chat</h3>
            <div id="chat-box"></div>
            <div style="display:flex; gap:10px;">
              <input type="text" id="chatInput" placeholder="Send a message to all students...">
              <button id="btnSendChat">Send</button>
            </div>
          </div>
        </section>

        <section id="reports-sec" class="content-section">
          <div style="display:flex; gap:20px; margin-bottom: 20px;">
            <div class="card" style="flex:1"><h3>Students</h3><h1 id="count-learners">0</h1></div>
            <div class="card" style="flex:1"><h3>Materials</h3><h1 id="count-mats">0</h1></div>
          </div>

          <div class="card">
            <h3>Student Assignment Submissions</h3>
            <table>
              <thead>
                <tr>
                  <th>Student Name</th>
                  <th>Student Email</th>
                  <th>Assignment</th>
                  <th>Link</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="submissionList"></tbody>
            </table>
          </div>
        </section>

      </div>
    </main>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getDatabase, ref, push, onValue, update, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDLvkRwSpd-hbPaDP31pV1H-4N5_Re-_xc",
    authDomain: "learnermanagementsystem-f3b6a.firebaseapp.com",
    databaseURL: "https://learnermanagementsystem-f3b6a-default-rtdb.firebaseio.com",
    projectId: "learnermanagementsystem-f3b6a",
    storageBucket: "learnermanagementsystem-f3b6a.firebasestorage.app",
    messagingSenderId: "173549259244",
    appId: "1:173549259244:web:f8722018a989c484a7d8c9"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // Initialize Lucide Icons
  lucide.createIcons();

  // Dark Mode Logic
  const themeToggle = document.getElementById('themeToggle');
  const themeIcon = document.getElementById('themeIcon');
  themeToggle.onclick = () => {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    themeIcon.setAttribute('data-lucide', isDark ? 'sun' : 'moon');
    lucide.createIcons();
  };

  const tertiaryCurriculum = {
    "BCom Accounting": ["Financial Accounting 101", "Business Management", "Commercial Law"],
    "BSc Computer Science": ["Intro to Programming", "Calculus 1", "Data Structures"],
    "LLB Law": ["Family Law", "Legal Foundations", "Criminal Law"],
    "Diploma in Engineering": ["Engineering Physics", "Technical Drawing", "Mechanics"]
  };

  onAuthStateChanged(auth, (user) => {
    document.getElementById('auth-section').style.display = user ? 'none' : 'block';
    document.getElementById('dashboard').style.display = user ? 'block' : 'none';
    document.getElementById('sidebar-nav').style.display = user ? 'block' : 'none';
    document.getElementById('signOutBtn').style.display = user ? 'block' : 'none';
    if(user) initApp();
  });

  function initApp() {
    document.querySelectorAll('.qual-drop').forEach(select => {
        select.innerHTML = '<option value="">-- Select Qual --</option>';
        Object.keys(tertiaryCurriculum).forEach(q => {
            select.innerHTML += `<option value="${q}">${q}</option>`;
        });
    });

    document.getElementById('qualSelect').onchange = (e) => {
        const mods = tertiaryCurriculum[e.target.value] || [];
        document.getElementById('modulePreview').innerHTML = mods.map(m => `<span class="subject-tag">${m}</span>`).join('');
    };

    onValue(ref(db, 'learners'), (snap) => {
      const list = document.getElementById('directoryList');
      list.innerHTML = '';
      let count = 0;
      snap.forEach(child => {
        count++;
        const d = child.val();
        list.innerHTML += `<tr><td>${d.email}</td><td>${d.assignedQual}</td><td>${(tertiaryCurriculum[d.assignedQual] || []).join(', ')}</td>
        <td><button class="danger" onclick="deleteItem('learners/${child.key}')">Delete</button></td></tr>`;
      });
      document.getElementById('count-learners').textContent = count;
    });

    onValue(ref(db, 'materials'), (snap) => {
      let count = 0;
      snap.forEach(() => count++);
      document.getElementById('count-mats').textContent = count;
    });

    onValue(ref(db, 'timetable'), (snap) => {
      const list = document.getElementById('timetableList');
      list.innerHTML = '';
      snap.forEach(child => {
        const d = child.val();
        list.innerHTML += `<tr><td>${d.day}</td><td>${d.time}</td><td>${d.subject}</td></tr>`;
      });
    });

    onValue(ref(db, 'chats'), (snap) => {
      const box = document.getElementById('chat-box');
      box.innerHTML = '';
      snap.forEach(child => {
        const d = child.val();
        box.innerHTML += `<div class="msg"><b>${d.user || 'Unknown User'}</b>${d.text}</div>`;
      });
      box.scrollTop = box.scrollHeight;
    });

    onValue(ref(db, 'submissions'), (snap) => {
      const list = document.getElementById('submissionList');
      list.innerHTML = '';
      snap.forEach(child => {
        const d = child.val();
        const sName = d.studentName || "Anonymous";
        const sEmail = d.studentEmail || "No Email Provided";
        
        list.innerHTML += `<tr>
          <td><b>${sName}</b></td>
          <td>${sEmail}</td>
          <td>${d.assignmentTitle || 'Assignment'}</td>
          <td><a href="${d.link}" target="_blank">View Work</a></td>
          <td><button class="danger" onclick="deleteItem('submissions/${child.key}')">Remove</button></td>
        </tr>`;
      });
    });
  }

  window.deleteItem = (path) => { if(confirm("Delete this?")) remove(ref(db, path)); };

  document.getElementById('provisionBtn').onclick = async () => {
    const email = document.getElementById('newLearnerEmail').value;
    const qual = document.getElementById('qualSelect').value;
    if(email && qual) {
        await push(ref(db, 'learners'), { email, assignedQual: qual, createdAt: serverTimestamp() });
        alert("Learner Added");
    }
  };

  document.getElementById('btnUploadMat').onclick = async () => {
    const title = document.getElementById('matTitle').value;
    const qual = document.getElementById('matQual').value;
    const link = document.getElementById('matLink').value;
    if(title && qual && link) {
        await push(ref(db, 'materials'), { title, qual, link });
        alert("Material Uploaded");
    }
  };

  document.getElementById('btnPostAss').onclick = async () => {
    const title = document.getElementById('assTitle').value;
    const qual = document.getElementById('assQual').value;
    const dueDate = document.getElementById('assDate').value;
    if(title && qual && dueDate) {
        await push(ref(db, 'assignments'), { title, qual, dueDate });
        alert("Assignment Issued");
    }
  };

  document.getElementById('btnAddTT').onclick = async () => {
    const day = document.getElementById('ttDay').value;
    const time = document.getElementById('ttTime').value;
    const subject = document.getElementById('ttSubject').value;
    if(day && time && subject) {
        await push(ref(db, 'timetable'), { day, time, subject });
    }
  };

  document.getElementById('btnSendChat').onclick = async () => {
    const text = document.getElementById('chatInput').value;
    if(text && auth.currentUser) {
        const identifier = `${auth.currentUser.displayName} (${auth.currentUser.email})`;
        await push(ref(db, 'chats'), { user: identifier, text, ts: serverTimestamp() });
        document.getElementById('chatInput').value = '';
    }
  };

  document.querySelectorAll('.nav-link').forEach(link => {
    link.onclick = () => {
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      link.classList.add('active');
      document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
      document.getElementById(link.dataset.target).classList.add('active');
      document.getElementById('view-title').textContent = link.innerText.trim();
    };
  });

  document.getElementById('googleSignInBtn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
  document.getElementById('signOutBtn').onclick = () => signOut(auth);
</script>
</body>
</html>
